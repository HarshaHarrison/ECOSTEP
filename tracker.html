<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EcoSteps - Tracker</title>
  <link rel="stylesheet" href="css/styles.css" />
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <!-- Navbar -->
  <nav style="background-color: #2e7d32; display: flex; align-items: center; justify-content: space-between; padding: 10px 20px;">
    <div style="color: white; font-size: 24px; font-weight: bold;">
      EcoSteps ğŸŒ¿
    </div>
    <ul style="display: flex; list-style: none; margin: 0; padding: 0;">
      <li style="margin: 0 15px;"><a href="index.html" style="color: white; text-decoration: none;">ğŸ  Home</a></li>
      <li style="margin: 0 15px;"><a href="calculator.html" style="color: white; text-decoration: none;">ğŸ“‹ Calculator</a></li>
      <li style="margin: 0 15px;"><a href="suggestions.html" style="color: white; text-decoration: none;">ğŸ’¡ Tips</a></li>
      <li style="margin: 0 15px;"><a href="tracker.html" style="color: white; text-decoration: none;">ğŸ“ˆ Tracker</a></li>
      <li style="margin: 0 15px;"><a href="facts.html" style="color: white; text-decoration: none;">ğŸ“š Quiz</a></li>
      <li style="margin: 0 15px;"><a href="sentiment.html" style="color: white; text-decoration: none;">ğŸ§  Sentiment</a></li>
    </ul>
  </nav>

  <main>
    <section class="tracker-section">
      <h2>Your Carbon Footprint Over Time</h2>
      <p>Log your emissions to see your progress toward a greener lifestyle.</p>

      <!-- Chart for visual trend -->
      <canvas id="emissionChart" style="max-width: 100%; height: 300px; margin-bottom: 30px;"></canvas>

      <!-- Form to log data -->
      <form id="log-form">
        <label>Date:
          <input type="date" id="date" required />
        </label>
        <label>Carbon Emission (tons COâ‚‚):
          <input type="number" id="emission" min="0" step="any" required />
        </label>
        <button type="submit">Add Entry</button>
      </form>

      <!-- Display entries -->
      <table id="log-table" style="margin-top: 20px; width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #a5d6a7;">
            <th style="padding: 8px; border: 1px solid #4caf50;">Date</th>
            <th style="padding: 8px; border: 1px solid #4caf50;">Emission (tons COâ‚‚)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Auth controls -->
      <div id="auth-section" style="margin-top: 20px;">
        <button id="login-btn" style="background-color: #4caf50; color: white; border: none; padding: 10px 15px; cursor: pointer;">Login with Google</button>
        <button id="logout-btn" style="display:none; background-color: #d32f2f; color: white; border: none; padding: 10px 15px; cursor: pointer;">Logout</button>
        <p id="user-info" style="color: green; margin-top: 10px;"></p>
      </div>
    </section>
  </main>

  <footer style="text-align: center; margin-top: 40px; padding: 15px; background-color: #e8f5e9; color: #2e7d32;">
    <p>Â© 2025 EcoSteps. All rights reserved.</p>
  </footer>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD4_Om1zCUrnrOim_OnWnwdMVMHNg3DvHQ",
      authDomain: "ecosteps-259a9.firebaseapp.com",
      projectId: "ecosteps-259a9",
      storageBucket: "ecosteps-259a9.firebasestorage.app",
      messagingSenderId: "199603477584",
      appId: "1:199603477584:web:5dec5304cf5daf738e4555",
      measurementId: "G-QSSPSXEK2W"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const form = document.getElementById('log-form');
    const tableBody = document.querySelector('#log-table tbody');

    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userInfo = document.getElementById('user-info');

    // Chart.js initialization
    const ctx = document.getElementById('emissionChart').getContext('2d');
    const myChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Carbon Emission (tons COâ‚‚)',
          data: [],
          backgroundColor: 'rgba(46, 125, 50, 0.2)',
          borderColor: 'rgba(46, 125, 50, 1)',
          borderWidth: 2,
          tension: 0.3,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Date' } },
          y: { title: { display: true, text: 'Emission (tons COâ‚‚)' }, beginAtZero: true }
        },
        plugins: {
          legend: { display: true }
        }
      }
    });

    // Real-time UI updates on auth state change
    auth.onAuthStateChanged(user => {
      if(user){
        userInfo.textContent = `Logged in as: ${user.displayName || user.email}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';

        // Real-time listener for emissions
        db.collection("users").doc(user.uid)
          .collection("emissions")
          .orderBy("date")
          .onSnapshot(snapshot => {
            tableBody.innerHTML = '';
            const dates = [];
            const emissions = [];
            snapshot.forEach(doc => {
              const data = doc.data();
              appendEntryToTable(data);
              dates.push(data.date);
              emissions.push(data.emission);
            });
            // Update Chart.js data
            myChart.data.labels = dates;
            myChart.data.datasets[0].data = emissions;
            myChart.update();
          });
      } else {
        userInfo.textContent = 'Not logged in';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        tableBody.innerHTML = '';
        myChart.data.labels = [];
        myChart.data.datasets[0].data = [];
        myChart.update();
      }
    });

    // Google login
    loginBtn.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(error => {
        console.error('Login error:', error);
        alert('Login failed. Please try again.');
      });
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      auth.signOut().catch(error => {
        console.error('Logout error:', error);
        alert('Logout failed. Please try again.');
      });
    });

    // Add new emission entry
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const user = auth.currentUser;
      if(!user){
        alert('Please log in to add entries.');
        return;
      }

      const date = document.getElementById('date').value;
      const emission = parseFloat(document.getElementById('emission').value);

      if(!date || isNaN(emission) || emission < 0){
        alert('Please enter valid date and emission value.');
        return;
      }

      try {
        await db.collection('users').doc(user.uid).collection('emissions').add({
          date,
          emission,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        form.reset();
      } catch(error){
        console.error('Error adding entry:', error);
        alert('Failed to save entry. Please try again.');
      }
    });

    // Append row to table
    function appendEntryToTable(entry){
      const row = document.createElement('tr');
      row.style.border = '1px solid #4caf50';
      row.innerHTML = `
        <td style="padding: 8px; border: 1px solid #4caf50;">${entry.date}</td>
        <td style="padding: 8px; border: 1px solid #4caf50;">${entry.emission}</td>
      `;
      tableBody.appendChild(row);
    }
  </script>
</body>
</html>
